<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<link href="style.css" rel="stylesheet">
	</head>
	<body>
        <div>
            <input type="text" id="project_name" value="">
            <button type="button" class="greenButton" onclick="createProjectButton()"><font size="5">Создать новый проект</font></button>
        </div>
        <div>
              <h2>Ваши проекты</h2>
              <ul id="list">
              </ul>
        </div>
        <script src="security.js"></script>
        <script>
            function loadProjects() {
                var output = document.getElementById('list');

                var sid = getCookie('sid');
                var request = JSON.stringify(
                    {
                        type: "get_projects",
                        sid:sid
                    } );

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/v1/getinfo', true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                xhr.onreadystatechange = function() {
                	if (this.readyState != 4)
            		return;

                    if (this.status === 200)
                    {
                        var obj = JSON.parse(this.responseText);
                        if (obj.status === 'success'){
                            for (i = 0; i < obj.data.length; i++) {
                                output.innerHTML+='<li><a href="dynamic/project/'
                                    + obj.data[i][0] + '">' + obj.data[i][2] + '</a></li>';
                            }
                        }
                    }
                };

                xhr.send(request);
            }

            function createProjectButton() {
                var x = document.getElementById("project_name").value;
                sendCreateProjectRequest(x);
            }

            function sendCreateProjectRequest(pname){
                var sid = getCookie('sid');
                var request = JSON.stringify(
                {
                    type: "create_project",
                    sid:sid,
                    name:pname
                } );

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/v1/create_project', true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                xhr.onreadystatechange = function(){
                    if (this.readyState != 4)
                        return;

                    if (this.status != 200)
                        return;

                    var response = JSON.parse(this.responseText);
                    if (response.status === 'success')
                        location.reload();
                }

                xhr.send(request);
            }

            securityCheck();
            loadProjects();
		</script>
	</body>
</html>
